name: CI

on:
  push:
    branches:
      - 'main'
      - 'hotfix**'
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore: # ignore docs only changes since they use a dedicated workflows: docs.yml
      - 'docs/**'
      - 'mithril-explorer/**'
      - '.github/workflows/docs.yml'
    branches-ignore:
      - 'hotfix**' # hotfix are handled by the push trigger

concurrency:
  group: ci-build-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ubuntu-X64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install stable toolchain, tools, and restore cache
        uses: ./.github/workflows/actions/toolchain-and-cache
        with:
          cache-version: ${{ secrets.CACHE_VERSION }}
          cargo-tools: cargo-deb

      - name: Build Mithril workspace & publish artifacts
        uses: ./.github/workflows/actions/build-upload-mithril-artifact

      - name: Build Debian packages
        shell: bash
        run: |
          cargo deb --no-build -p mithril-aggregator
          cargo deb --no-build -p mithril-signer
          cargo deb --no-build -p mithril-client
      
      - name: Publish Debian packages
        uses: actions/upload-artifact@v3
        with:
          name: mithril-deb-packages-${{ runner.os }}-${{ runner.arch }}
          path: target/debian/*.deb
          if-no-files-found: error

      - name: Publish End-to-end runner (${{ runner.os }}-${{ runner.arch }})
        uses: actions/upload-artifact@v3
        with:
          name: mithril-end-to-end-${{ runner.os }}-${{ runner.arch }}
          path: target/release/mithril-end-to-end
          if-no-files-found: error
  
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-12, windows-latest ]
        
        include:
        # Only build client on windows & mac
        - os: macos-12
          build-args: -p mithril-client
        - os: windows-latest
          build-args: -p mithril-client 
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install stable toolchain and restore cache
        uses: ./.github/workflows/actions/toolchain-and-cache
        with:
          cache-version: ${{ secrets.CACHE_VERSION }}
      
      - name: Build Mithril workspace & publish artifacts
        uses: ./.github/workflows/actions/build-upload-mithril-artifact
        with:
          build-args: ${{ matrix.build-args }}
  
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-22.04, macos-12, windows-latest ]
        
        include:
          - os: ubuntu-22.04
            build-args: --workspace
            test-args: --workspace
          # Only test client on windows & mac (since its the only binaries supported for those os for now)
          - os: macos-12
            build-args: -p mithril-client
            test-args: -p mithril-client
          - os: windows-latest
            build-args: -p mithril-client
            test-args: -p mithril-client
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install stable toolchain, tools, and restore cache
        uses: ./.github/workflows/actions/toolchain-and-cache
        with:
          cache-version: ${{ secrets.CACHE_VERSION }}
          cargo-tools: cargo2junit

      - name: Run tests
        shell: bash
        run: |
          set -o pipefail && \
          cargo test --features portable --no-fail-fast ${{ matrix.test-args }} \
              -- -Z unstable-options --format json --report-time \
              | tee >(cargo2junit > test-results${{ matrix.artifact-suffix }}-${{ runner.os }}-${{ runner.arch }}.xml)

      - name: Upload Tests Results
        uses: actions/upload-artifact@v3
        if: success() || failure()
        with:
          name: test-results${{ matrix.artifact-suffix }}-${{ runner.os }}-${{ runner.arch }}
          path: |
            ./**/test-results-*.xml
  
  check:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install stable toolchain, tools, and restore cache
        uses: ./.github/workflows/actions/toolchain-and-cache
        with:
          cache-version: ${{ secrets.CACHE_VERSION }}
          cargo-tools: cargo-sort clippy-sarif sarif-fmt

      - name: Clippy Check
        if: success() || failure()
        run: |
          cargo clippy \
            --all-features --all-targets --no-deps --message-format=json \
            | clippy-sarif | tee rust-clippy-results.sarif | sarif-fmt
          
          # Make this step fail if any warning has been found
          if [[ $(cat rust-clippy-results.sarif | jq '.runs[0].results') != "[]" ]]; then
            false
          fi

      - name: Upload clippy analysis results to GitHub
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: rust-clippy-results.sarif
          wait-for-processing: true

      - name: Cargo fmt
        if: success() || failure()
        shell: bash
        run: cargo fmt --check

      - name: Cargo sort
        if: success() || failure()
        shell: bash
        run: cargo sort -w -c

  run-test-lab:
    runs-on: ubuntu-22.04
    needs: [ build-ubuntu-X64 ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Download binaries
        uses: actions/download-artifact@v3
        with:
          name: mithril-distribution-${{ runner.os }}-${{ runner.arch }}
          path: ./bin

      - name: Download rust test runner
        uses: actions/download-artifact@v3
        with:
          name: mithril-end-to-end-${{ runner.os }}-${{ runner.arch }}
          path: ./

      - run: |
          chmod +x ./bin/mithril-aggregator
          chmod +x ./bin/mithril-client
          chmod +x ./bin/mithril-signer
          chmod +x ./mithril-end-to-end
          mkdir artifacts

      - name: Test
        run: ./mithril-end-to-end --bin-directory ./bin --work-directory=./artifacts --devnet-scripts-directory=./mithril-test-lab/mithril-devnet

      - name: Upload E2E Tests Artifacts
        if:  ${{ failure() }}
        uses: actions/upload-artifact@v3
        with:
          name: mithril-e2e-tests-artifacts-run_${{ github.run_number }}-attempt_${{ github.run_attempt }}
          path: |
            ./artifacts/*
            # including node.sock makes the upload fails so exclude them:
            !./artifacts/**/node.sock
            # exclude cardano tools, saving ~50mb of data:
            !./artifacts/devnet/cardano-cli
            !./artifacts/devnet/cardano-node
          if-no-files-found: error
  
  publish-tests-results:
    if: success() || failure()
    runs-on: ubuntu-22.04
    needs: 
      - test
    steps:
      - name: Download Tests Results (${{ runner.os }}-${{ runner.arch }})
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: test-results-${{ runner.os }}-${{ runner.arch }}

      - name: Download Tests Results (macOS-X64)
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: test-results-macOS-X64

      - name: Download Tests Results (Windows-X64)
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: test-results-Windows-X64

      - name: Publish Unit Test Results
        if: success() || failure()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          junit_files: ./**/test-results-*.xml

  docker-mithril:
    runs-on: ubuntu-22.04
    needs:
      - build
      - check
      - test
      - run-test-lab
    strategy:
      fail-fast: false
      matrix:
        project: [ mithril-aggregator, mithril-client, mithril-signer ]
    
    permissions:
      contents: read
      packages: write

    env:
      PUSH_PACKAGES: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith('refs/heads/hotfix', github.ref)) }}
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/${{ matrix.project }}
      DOCKER_FILE: ./${{ matrix.project }}/Dockerfile.ci
      CONTEXT: .

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            unstable
            type=raw,value=${{ github.base_ref || github.ref_name }}-{{sha}}

      - name: Download built artifacts
        uses: actions/download-artifact@v3
        with:
          name: mithril-distribution-${{ runner.os }}-${{ runner.arch }}
          path: ${{ matrix.project }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v3
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: ${{ env.PUSH_PACKAGES }}
          tags: ${{ steps.meta.outputs.tags }}

  unstable-release:
    #TODO: rollback
    #if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith('refs/heads/hotfix', github.ref))
    runs-on: ubuntu-22.04
    needs:
      - build
      - test
      # TODO: rollback
      #- run-test-lab
      - check
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
      
      - name: Prepare packaging
        run: mkdir package

      - name: Get short SHA
        id: slug
        run: echo "sha8=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: Download built artifacts (Linux-X64)
        uses: actions/download-artifact@v3
        with:
          name: mithril-distribution-Linux-X64
          path: ./package-Linux-X64

      - name: Download Debian packages (Linux-X64)
        uses: actions/download-artifact@v3
        with:
          name: mithril-deb-packages-Linux-X64
          path: ./package

      - name: Download built artifacts (macOS-X64)
        uses: actions/download-artifact@v3
        with:
          name: mithril-distribution-macOS-X64
          path: ./package-macOS-X64

      - name: Download built artifacts (Windows-X64)
        uses: actions/download-artifact@v3
        with:
          name: mithril-distribution-Windows-X64
          path: ./package-Windows-X64

      - name: Package distribution (Linux-X64)
        run: |
          python3 ./.github/workflows/scripts/package-distribution.py \
          --input package-Linux-X64/ \
          --dest package/ \
          --version "unstable-${{ steps.slug.outputs.sha8 }}" \
          --target "linux-x64"

      - name: Package distribution (macOS-X64)
        run: |
          python3 ./.github/workflows/scripts/package-distribution.py \
          --input package-macOS-X64/ \
          --dest package/ \
          --version "unstable-${{ steps.slug.outputs.sha8 }}" \
          --target "macos-x64"

      - name: Package distribution (Windows-X64)
        run: |
          python3 ./.github/workflows/scripts/package-distribution.py \
          --input package-Windows-X64/ \
          --dest package/ \
          --version "unstable-${{ steps.slug.outputs.sha8 }}" \
          --target "windows-x64"

      - name: Create and Sign sha256 checksum
        run: |
          mkdir gpghome
          chmod 700 gpghome
          echo "${{ secrets.GPG_SECRET_KEY }}" | gpg --homedir gpghome --batch --import
          gpg --homedir gpghome --list-secret-keys
          gpg --export --armor mithril@iohk.io > ./package/gpg-public.key
          cd ./package
          find . -type f -print | grep -v CHECKSUM | sort -n | xargs -I '{}' sha256sum '{}' > ./CHECKSUM
          gpg --homedir ../gpghome --clear-sign ./CHECKSUM
          rm -f ./CHECKSUM
          sha256sum -c ./CHECKSUM.asc
          gpg --homedir ../gpghome --verify ./CHECKSUM.asc
          cd ..
          GPG_FINGERPRINT=$(gpg --homedir gpghome --fingerprint "mithril@iohk.io" | head -n 2 | tail -n 1 | xargs)
          cat > ./asset-verify.txt << EOF

            ## Verify the authenticity of a downloaded asset
            <details><summary>Process to verify an asset</summary>
            <p>
            
            * **Step 1**: Identify your downloaded asset ***YOUR_ASSET_FILE***
            * **Step 2**: Download the signed checksum file from this link [CHECKSUM.asc](./CHECKSUM.asc) and save it in the same folder as the asset
            * **Step 3**: In your terminal, go to the asset folder by running:
            \`\`\`
            cd ***YOUR_ASSET_FOLDER***
            \`\`\`
            * **Step 4**: Then verify the checksum of the asset by running:
            \`\`\`
            sha256sum -c ./CHECKSUM.asc 2>&1 >/dev/null | grep ***YOUR_ASSET_FILE***
            \`\`\`
            You must see:
            \`\`\`
            ./***YOUR_ASSET_FILE***: OK
            \`\`\`
            * **Step 5**: Download the public key file from this link [gpg-public.key](./gpg-public.key) and save it in the same folder as the asset
            * **Step 6**: Then import the GPG public key:
            \`\`\`
            gpg --import ./gpg-public.key
            \`\`\`
            You must see something like:
            \`\`\`
            gpg: key : public key "Input Output / Mithril <mithril@iohk.io>" imported
            gpg: Total number processed: 1
            gpg:               imported: 1
            \`\`\`
            * **Step 7**: Then verify the GPG signature of the checksum file:
            \`\`\`
            gpg --verify ./gpg-public.key ./CHECKSUM.asc
            \`\`\`
            You must see something like:
            \`\`\`
            gpg: Signature made Mon 05 Dec 2022 04:53:54 PM CET
            gpg:                using RSA key 35EDE9D47BBA62A2F388E655899ACD26B8BCA0D2
            gpg: Good signature from "Input Output / Mithril <mithril@iohk.io>" [unknown]
            gpg: WARNING: This key is not certified with a trusted signature!
            gpg:          There is no indication that the signature belongs to the owner.
            Primary key fingerprint: 35ED E9D4 7BBA 62A2 F388  E655 899A CD26 B8BC A0D2
            \`\`\`
            The signature is valid if and only if:
            - there is a line with \`gpg: Good signature from "Input Output / Mithril <mithril@iohk.io>"\`
            - there is a line with \`Primary key fingerprint: ${GPG_FINGERPRINT}\`
            * **Step 8**:
            If you successfully validated all the steps of this process, then you have successfully verified the authenticity of the asset :heavy_check_mark:
            If not, contact us at [mithril@iohk.io] and let us know of the outcome of your run of this process :warning:

            </p>
            </details>
          EOF

          cat ./asset-verify.txt
          rm -rf gpghome

      - name: List packaged files
        run: |
          ls -al ./package
      
      # TODO: rollback
      #- name: Update unstable release
      #  uses: marvinpinto/action-automatic-releases@latest
      #  with:
      #    repo_token: ${{ secrets.GITHUB_TOKEN }}
      #    automatic_release_tag: unstable
      #    prerelease: true
      #    title: Unstable Development Builds
      #    files: package/*

  deploy-testing:
    # Don't run on pull request from forks since they don't have access to all the needed secrets
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork)
    strategy:
      fail-fast: false
      matrix:
        environment: [ testing-preview ]
        include:
        - environment: testing-preview
          environment_prefix: testing
          cardano_network: preview
          mithril_api_domain: api.mithril.network
          mithril_protocol_parameters: |
            {
              k     = 2422
              m     = 20973
              phi_f = 0.2
            }
          mithril_signers: |
            {
              "1" = {
                type    = "unverified",
                pool_id = "pool18r62tz408lkgfu6pq5svwzkh2vslkeg6mf72qf3h8njgvzhx9ce",
              },
              "2" = {
                type    = "verified",
                pool_id = "",
              },
            }
          terraform_backend_bucket: hydra-terraform-admin
          google_region: europe-west1
          google_zone: europe-west1-b
          google_machine_type: e2-medium
          
    runs-on: ubuntu-22.04

    needs:
      - docker-mithril

    environment: ${{ matrix.environment }}

    env:
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      GENESIS_SECRET_KEY: ${{ secrets.GENESIS_SECRET_KEY }}
      GENESIS_VERIFICATION_KEY_URL: ${{ secrets.GENESIS_VERIFICATION_KEY_URL }}

    defaults:
      run:
        working-directory: mithril-infra

    steps:

    - name: Checkout sources
      uses: actions/checkout@v3

    - name: Get Docker image id
      run: echo "DOCKER_IMAGE_ID=${{ github.base_ref || github.ref_name }}-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV

    - name: Prepare service account credentials
      run: |
        echo '${{ env.GOOGLE_APPLICATION_CREDENTIALS}}' > ./google-application-credentials.json
        chmod u+x ./assets/tools/utils/google-credentials-public-key.sh
        ./assets/tools/utils/google-credentials-public-key.sh ./google-application-credentials.json ./assets/ssh_keys curry

    - name: Prepare terraform variables
      run: |
        cat > ./env.variables.tfvars << EOF
          environment_prefix                   = "${{ matrix.environment_prefix }}"
          cardano_network                      = "${{ matrix.cardano_network }}"
          google_region                        = "${{ matrix.google_region }}"
          google_zone                          = "${{ matrix.google_zone }}"
          google_machine_type                  = "${{ matrix.google_machine_type }}"
          google_service_credentials_json_file = "./google-application-credentials.json"
          mithril_api_domain                   = "${{ matrix.mithril_api_domain }}"
          mithril_image_id                     = "${{ env.DOCKER_IMAGE_ID }}"
          mithril_genesis_verification_key_url = "${{ env.GENESIS_VERIFICATION_KEY_URL }}"
          mithril_genesis_secret_key           = "${{ env.GENESIS_SECRET_KEY }}"
          mithril_protocol_parameters          = ${{ matrix.mithril_protocol_parameters }}
          mithril_signers                      = ${{ matrix.mithril_signers }}
        EOF
        terraform fmt ./env.variables.tfvars
        cat ./env.variables.tfvars

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    - name: Init Terraform
      run: |
        GOOGLE_APPLICATION_CREDENTIALS=./google-application-credentials.json terraform init -backend-config="bucket=${{ matrix.terraform_backend_bucket }}" -backend-config="prefix=terraform/mithril-${{ matrix.environment }}"

    - name: Check Terraform
      run: terraform fmt -check

    - name: Terraform Plan
      run: |
        GOOGLE_APPLICATION_CREDENTIALS=./google-application-credentials.json terraform plan --var-file=./env.variables.tfvars

    - name: Terraform Apply
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        GOOGLE_APPLICATION_CREDENTIALS=./google-application-credentials.json terraform apply -auto-approve --var-file=./env.variables.tfvars

    - name: Cleanup
      run: |
        rm -f ./env.variables.tfvars
        rm -f ./google-application-credentials.json