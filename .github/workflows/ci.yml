name: CI

# do not run workflow twice on PRs
on: [push]

jobs:
  build-mithril-core:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-core/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-core/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-core/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path ./mithril-core/Cargo.toml

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --all-targets --manifest-path ./mithril-core/Cargo.toml

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --manifest-path ./mithril-core/Cargo.toml -- --check

      - name: Clippy Check
        uses: actions-rs/clippy-check@v1
        with:
          name: clippy-mithril-core
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --manifest-path ./mithril-core/Cargo.toml --all-features

      - name: Compile benchmarks
        uses: actions-rs/cargo@v1
        continue-on-error: false
        with:
          command: bench
          args: --no-run --locked --manifest-path ./mithril-core/Cargo.toml

      - name: Mithril Core / Generate doc
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --release --manifest-path ./mithril-core/Cargo.toml

      - name: Publish libmithril
        uses: actions/upload-artifact@v3
        with:
          name: libmithril
          if-no-files-found: error
          path: |
            mithril-core/target/release/libmithril.so
            mithril-core/target/include/mithril.h

      - name: Publish libmithril-doc
        uses: actions/upload-artifact@v3
        with:
          name: libmithril-doc
          if-no-files-found: error
          path: |
            mithril-core/target/doc/

  test-mithril-core:
    if: github.event.pull_request.draft == false
    needs:
    - build-mithril-core
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-core/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-core/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-core/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - uses: actions/cache@v2.1.5
        name: Cache cargo2junit
        with:
          path: |
            ~/.cargo/bin/cargo2junit
          key: ${{ runner.os }}-${{ hashFiles('~/.cargo/bin/cargo2junit') }}
          restore-keys: |
            ${{ runner.os }}-cargo2junit-key

      - name: Download mithril core
        uses: actions/download-artifact@v3
        with:
          name: libmithril
          path: mithril-core/target/include/

      - name: Install cargo2junit
        run: |
          # Suppress the "binary `cargo2junit` already exists in destination" error
          cargo install cargo2junit 2>/dev/null || true

      - name: Run cargo test
        shell: bash
        working-directory: mithril-core
        run: |
          set -o pipefail && cargo test --release -- -Z unstable-options --format json --report-time | tee >(cargo2junit > test-results-mithril-core.xml)

      - name: Set up Clang
        uses: egor-tensin/setup-clang@v1
        with:
          version: latest
          platform: x64

      - name: Install gtest manually
        run: sudo apt-get install libgtest-dev && cd /usr/src/gtest && sudo cmake CMakeLists.txt && sudo make && sudo cp lib/*.a /usr/lib && sudo ln -s /usr/lib/libgtest.a /usr/local/lib/libgtest.a && sudo ln -s /usr/lib/libgtest_main.a /usr/local/lib/libgtest_main.a

      - name: Build C test
        run: clang -x c++ tests.c stms.c -g -o tests -L ../target/release -lmithril -lpthread -lstdc++ -lgtest -lgtest_main
        working-directory: mithril-core/c-tests

      - name: Run C test
        run: LD_LIBRARY_PATH=../target/release ./tests --gtest_output=xml:test-results-ctest-mithril-core.xml
        working-directory: mithril-core/c-tests

      - name: Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-mithril-core
          path: |
            ./**/test-results-*.xml

  build-mithril:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        project: [ mithril-common, mithril-aggregator, mithril-client, mithril-signer ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache ${{ matrix.project }}/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.project }}/target
          key: ${{ runner.os }}-${{ hashFiles('${{ matrix.project }}/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-key

      - uses: actions/cache@v2.1.5
        name: Cache cargo2junit
        with:
          path: |
            ~/.cargo/bin/cargo2junit
          key: ${{ runner.os }}-${{ hashFiles('~/.cargo/bin/cargo2junit') }}
          restore-keys: |
            ${{ runner.os }}-cargo2junit-key

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path ./${{ matrix.project }}/Cargo.toml

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --all-targets --manifest-path ./${{ matrix.project }}/Cargo.toml

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --manifest-path ./${{ matrix.project }}/Cargo.toml -- --check

      - name: Clippy Check
        uses: actions-rs/clippy-check@v1
        with:
          name: clippy-${{ matrix.project }}
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --manifest-path ./${{ matrix.project }}/Cargo.toml --all-features

      - name: Install cargo2junit
        run: |
          # Suppress the "binary `cargo2junit` already exists in destination" error
          cargo install cargo2junit 2>/dev/null || true

      - name: Run cargo test
        shell: bash
        working-directory: ${{ matrix.project }}
        run: |
          set -o pipefail && cargo test --release -- -Z unstable-options --format json --report-time | tee >(cargo2junit > test-results-${{ matrix.project }}.xml)

      - name: Generate ${{ matrix.project }} doc
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --release --manifest-path ./${{ matrix.project }}/Cargo.toml

      - name: Publish ${{ matrix.project }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.project }}
          path: |
            ${{ matrix.project }}/target/release/${{ matrix.project }}
            ${{ matrix.project }}/target/release/lib*.so
          if-no-files-found: error

      - name: Publish ${{ matrix.project }}-doc
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.project }}-doc
          if-no-files-found: error
          path: |
            ${{ matrix.project }}/target/doc/

      - name: Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.project }}
          path: |
            ./**/test-results-*.xml

  docker-mithril:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    needs: [ build-mithril-core, build-mithril ]
    strategy:
      fail-fast: false
      matrix:
        project: [ mithril-aggregator, mithril-client, mithril-signer ]
    
    permissions:
      contents: read
      packages: write

    env:
      PUSH_PACKAGES: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/${{ matrix.project }}
      DOCKER_FILE: ./${{ matrix.project }}/Dockerfile.ci
      CONTEXT: .
      GITHUB_REF: ${{ github.ref}}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Log in to the Container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags:
            type=raw,value={{branch}}-{{sha}}

      - name: Download ${{ matrix.project }} executable
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.project }}
          path: ${{ matrix.project }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: ${{ env.PUSH_PACKAGES }}
          tags: ${{ steps.meta.outputs.tags }}
          
  publish-tests-results:
    if: github.event.pull_request.draft == false && ${{ always() }}
    runs-on: ubuntu-latest
    needs: [ build-mithril, test-mithril-core ]
    steps:
      - name: Download mithril-core Tests Results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: test-results-mithril-core

      - name: Download mithril-common Tests Results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: test-results-mithril-common
      
      - name: Download mithril-aggregator Tests Results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: test-results-mithril-aggregator

      - name: Download mithril-client Tests Results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: test-results-mithril-client

      - name: Download mithril-signer Tests Results
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: test-results-mithril-signer
      
      - name: Publish Unit Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v1
        with:
          files: ./**/test-results-*.xml

  generate-publish-docs:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    needs:
      - build-mithril
      - docker-mithril
      - test-mithril-core
      - build-test-lab
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Download libmithril-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: libmithril-doc
          path: ./github-pages/mithril-core/doc

      - name: Download mithril-common-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-common-doc
          path: ./github-pages/mithril-common/doc

      - name: Download aggregator-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-aggregator-doc
          path: ./github-pages/mithril-aggregator/doc

      - name: Download client-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-client-doc
          path: ./github-pages/mithril-client/doc

      - name: Download signer-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-signer-doc
          path: ./github-pages/mithril-signer/doc

      - name: Mithril Aggregator / Generate OpenAPI UI
        uses: Legion2/swagger-ui-action@v1
        with:
          output: ./github-pages/openapi-ui
          spec-file: ./openapi.yaml

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'
          cache-dependency-path: docs/yarn.lock

      - name: Documentation (Docusaurus)
        working-directory: docs
        run: |
          yarn && yarn build
          mkdir -p ../github-pages/doc
          mv build/* ../github-pages/doc
          echo "mithril.network" > ../github-pages/CNAME
          echo '<!DOCTYPE html><html><head><meta http-equiv="Refresh" content="0; URL=https://mithril.network/doc"></head></html>' > ../github-pages/index.html

      - name: Mithril / Publish Github Pages
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN || github.token }}
          publish_dir: ./github-pages

  build-test-lab:
    runs-on: ubuntu-latest
    needs: [ build-mithril-core, build-mithril ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Prepare nix
        uses: cachix/install-nix-action@v13
        with:
          skip_adding_nixpkgs_channel: true
          extra_nix_config: |
            trusted-public-keys = iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
            substituters = https://cache.nixos.org https://hydra.iohk.io https://iohk.cachix.org

      - name: Github cache ~/.cabal/packages, ~/.cabal/store and dist-newstyle
        uses: actions/cache@v2.1.5
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            mithril-test-lab/dist-newstyle
          key: |
            cabal-${{ runner.os }}-${{ hashFiles('mithril-test-lab/cabal.project', 'shell.nix') }}

      - name: Prepare nix-shell
        run: |
          nix-build shell.nix

      - name: Download aggregator
        uses: actions/download-artifact@v3
        with:
          name: mithril-aggregator
          path: ~/.cabal/bin/

      - name: Download signer
        uses: actions/download-artifact@v3
        with:
          name: mithril-signer
          path: ~/.cabal/bin/

      - name: Download client
        uses: actions/download-artifact@v3
        with:
          name: mithril-client
          path: ~/.cabal/bin/

      - run: |
          chmod +x ~/.cabal/bin/mithril-aggregator
          chmod +x ~/.cabal/bin/mithril-client
          chmod +x ~/.cabal/bin/mithril-signer


      - name: Build
        run: nix-shell --run '.github/workflows/ci-build.sh'

      - name: Test
        env:
          NETWORK: testnet
          URL_SNAPSHOT_MANIFEST: https://storage.googleapis.com/cardano-testnet/snapshots.json
        run: nix-shell --run '.github/workflows/ci-test.sh'

  terraform:
    runs-on: ubuntu-latest
    needs:
    - docker-mithril
    - test-mithril-core
    - build-test-lab
    env:
      # Contains a JSON-formatted service account key
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      # Contains a RSA private key
      GCLOUD_PRIVATE_KEY: ${{ secrets.GCLOUD_PRIVATE_KEY }}
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

    defaults:
      run:
        working-directory: mithril-infra

    steps:

    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Get short SHA
      id: slug
      run: echo "::set-output name=sha8::$(echo ${{ github.sha }} | cut -c1-7)"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false

    - name: Init Terraform
      run: terraform init

    - name: Check Terraform
      run: terraform fmt -check

    - name: Terraform Plan
      run: |
        terraform plan -var "image_id=${{ env.BRANCH_NAME }}-${{ steps.slug.outputs.sha8 }}" -var 'private_key=${{ env.GCLOUD_PRIVATE_KEY }}' -var 'google_application_credentials_json=${{ env.GOOGLE_CREDENTIALS }}'

    - name: Update Pull Request
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      env:
        PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `#### Terraform Format and Style 🖌\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization ⚙️\`${{ steps.init.outcome }}\`
          #### Terraform Plan 📖\`${{ steps.plan.outcome }}\`
          #### Terraform Validation 🤖\`${{ steps.validate.outcome }}\`

          <details><summary>Show Plan</summary>

          \`\`\`\n
          ${process.env.PLAN}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        terraform apply -auto-approve  -var "image_id=${{ env.BRANCH_NAME }}-${{ steps.slug.outputs.sha8 }}" -var 'private_key=${{ env.GCLOUD_PRIVATE_KEY }}' -var 'google_application_credentials_json=${{ env.GOOGLE_CREDENTIALS }}'
