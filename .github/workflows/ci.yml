name: CI

# do not run workflow twice on PRs
on:
  push:
  pull_request:
    types: [opened, reopened]

jobs:
  build-mithril-core:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-core/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-core/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-core/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path ./mithril-core/Cargo.toml

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --all-targets --manifest-path ./mithril-core/Cargo.toml

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --manifest-path ./mithril-core/Cargo.toml -- --check

      - name: Clippy Check
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --manifest-path ./mithril-core/Cargo.toml --all-features

      - name: Compile benchmarks
        uses: actions-rs/cargo@v1
        continue-on-error: false
        with:
          command: bench
          args: --no-run --locked --manifest-path ./mithril-core/Cargo.toml

      - name: Mithril Core / Generate doc
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --release --manifest-path ./mithril-core/Cargo.toml

      - name: Publish libmithril
        uses: actions/upload-artifact@v3
        with:
          name: libmithril
          path: |
            mithril-core/target/release/libmithril.so
            mithril-core/target/include/mithril.h

      - name: Publish libmithril-doc
        uses: actions/upload-artifact@v3
        with:
          name: libmithril-doc
          path: |
            mithril-core/target/doc/

  test-mithril-core:
    if: github.event.pull_request.draft == false
    needs:
    - build-mithril-core
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-core/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-core/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-core/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - name: Download mithril core
        uses: actions/download-artifact@v3
        with:
          name: libmithril
          path: mithril-core/target/include/

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --manifest-path ./mithril-core/Cargo.toml

      - name: Set up Clang
        uses: egor-tensin/setup-clang@v1
        with:
          version: latest
          platform: x64

      - name: Install gtest manually
        run: sudo apt-get install libgtest-dev && cd /usr/src/gtest && sudo cmake CMakeLists.txt && sudo make && sudo cp lib/*.a /usr/lib && sudo ln -s /usr/lib/libgtest.a /usr/local/lib/libgtest.a && sudo ln -s /usr/lib/libgtest_main.a /usr/local/lib/libgtest_main.a

      - name: Build C test
        run: clang -x c++ tests.c stms.c -g -o tests -L ../target/release -lmithril -lpthread -lstdc++ -lgtest -lgtest_main
        working-directory: mithril-core/c-tests

      - name: Run C test
        run: LD_LIBRARY_PATH=../target/release ./tests --gtest_output=xml:test-results.xml
        working-directory: mithril-core/c-tests

      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        with:
          files: ./**/test-results.xml

  build-mithril-aggregator:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-network/mithril-aggregator/Cargo.lock
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-network/mithril-aggregator/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-network/mithril-aggregator/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --all-targets --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml -- --check

      - name: Clippy Check
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml --all-features

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml

      - name: Mithril Aggregator / Generate doc
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --release --manifest-path ./mithril-network/mithril-aggregator/Cargo.toml

      - name: Publish aggregator
        uses: actions/upload-artifact@v3
        with:
          name: mithril-aggregator
          path: mithril-network/mithril-aggregator/target/release/mithril-aggregator

      - name: Publish aggregator-doc
        uses: actions/upload-artifact@v3
        with:
          name: mithril-aggregator-doc
          path: |
            mithril-network/mithril-aggregator/target/doc/

  build-mithril-client:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - uses: actions/cache@v2.1.5
        name: Cache mithril-network/mithril-client/Cargo.toml
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mithril-network/mithril-client/target
          key: ${{ runner.os }}-${{ hashFiles('mithril-network/mithril-client/Cargo.lock') }}
          restore-keys: |
              ${{ runner.os }}-key

      - name: Cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path ./mithril-network/mithril-client/Cargo.toml

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --release --all-targets --manifest-path ./mithril-network/mithril-client/Cargo.toml

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all --manifest-path ./mithril-network/mithril-client/Cargo.toml -- --check

      - name: Clippy Check
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --manifest-path ./mithril-network/mithril-client/Cargo.toml --all-features

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --manifest-path ./mithril-network/mithril-client/Cargo.toml

      - name: Mithril Client / Generate doc
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --release --manifest-path ./mithril-network/mithril-client/Cargo.toml

      - name: Publish client
        uses: actions/upload-artifact@v3
        with:
          name: mithril-client
          path: mithril-network/mithril-client/target/release/mithril-client

      - name: Publish client-doc
        uses: actions/upload-artifact@v3
        with:
          name: mithril-client-doc
          path: |
            mithril-network/mithril-client/target/doc/

  build-mithril-node-poc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - uses: actions/setup-go@v2
        with:
          go-version: '1.17.1'

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - name: install mlib
        run: make mlib
        working-directory: mithril-proto/mithril-node-poc/

      - name: Golang Tests
        run: go test ./...
        working-directory: mithril-proto/mithril-node-poc/

  docker-mithril-node-poc:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: [ build-mithril-core, build-mithril-node-poc ]
    permissions:
      contents: read
      packages: write

    env:
      PUSH_PACKAGES: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/mithril-node-poc
      DOCKER_FILE: ./mithril-proto/mithril-node-poc/Dockerfile
      CONTEXT: .
      GITHUB_REF: ${{ github.ref}}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Log in to the Container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags:
            type=raw,value={{branch}}-{{sha}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: ${{ env.PUSH_PACKAGES }}
          tags: ${{ steps.meta.outputs.tags }}

  docker-mithril-aggregator:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    needs: [ build-mithril-core, build-mithril-aggregator ]
    permissions:
      contents: read
      packages: write

    env:
      PUSH_PACKAGES: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/mithril-aggregator
      DOCKER_FILE: ./mithril-network/mithril-aggregator/Dockerfile.ci
      CONTEXT: .
      GITHUB_REF: ${{ github.ref}}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Log in to the Container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags:
            type=raw,value={{branch}}-{{sha}}

      - name: Download mithril aggregator executable
        uses: actions/download-artifact@v3
        with:
          name: mithril-aggregator
          path: .

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: ${{ env.PUSH_PACKAGES }}
          tags: ${{ steps.meta.outputs.tags }}

  docker-mithril-client:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    needs: [ build-mithril-core, build-mithril-client ]
    permissions:
      contents: read
      packages: write

    env:
      PUSH_PACKAGES: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/mithril-client
      DOCKER_FILE: ./mithril-network/mithril-client/Dockerfile.ci
      CONTEXT: .
      GITHUB_REF: ${{ github.ref}}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Log in to the Container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags:
            type=raw,value={{branch}}-{{sha}}

      - name: Download mithril client executable
        uses: actions/download-artifact@v3
        with:
          name: mithril-client
          path: .

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: ${{ env.PUSH_PACKAGES }}
          tags: ${{ steps.meta.outputs.tags }}

  generate-publish-docs:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    needs: [ build-mithril-core, build-mithril-aggregator, build-mithril-client ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Download libmithril-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: libmithril-doc
          path: ./github-pages/mithril-core/doc

      - name: Download aggregator-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-aggregator-doc
          path: ./github-pages/mithril-network/mithril-aggregator/doc

      - name: Download client-doc artifact
        uses: actions/download-artifact@v3
        with:
          name: mithril-client-doc
          path: ./github-pages/mithril-network/mithril-client/doc

      - name: Mithril Aggregator / Generate OpenAPI UI
        uses: Legion2/swagger-ui-action@v1
        with:
          output: ./github-pages/openapi-ui
          spec-file: ./mithril-network/openapi.yaml

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'
          cache-dependency-path: docs/yarn.lock

      - name: Documentation (Docusaurus)
        working-directory: docs
        run: |
          yarn && yarn build
          mkdir -p ../github-pages/doc
          mv build/* ../github-pages/doc
          echo "mithril.network" > ../github-pages/CNAME
          echo '<!DOCTYPE html><html><head><meta http-equiv="Refresh" content="0; URL=https://mithril.network/doc"></head></html>' > ../github-pages/index.html

      - name: Mithril / Publish Github Pages
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN || github.token }}
          publish_dir: ./github-pages

  build-test-lab:
    runs-on: ubuntu-latest
    needs: [ build-mithril-core, build-mithril-aggregator ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Prepare nix
        uses: cachix/install-nix-action@v13
        with:
          skip_adding_nixpkgs_channel: true
          extra_nix_config: |
            trusted-public-keys = iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
            substituters = https://cache.nixos.org https://hydra.iohk.io https://iohk.cachix.org

      - name: Github cache ~/.cabal/packages, ~/.cabal/store and dist-newstyle
        uses: actions/cache@v2.1.5
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            mithril-test-lab/dist-newstyle
          key: |
            cabal-${{ runner.os }}-${{ hashFiles('mithril-test-lab/cabal.project', 'shell.nix') }}

      - name: Prepare nix-shell
        run: |
          nix-build shell.nix

      - name: Download aggregator
        uses: actions/download-artifact@v3
        with:
          name: mithril-aggregator
          path: ~/.cabal/bin/

      - run: chmod +x ~/.cabal/bin/mithril-aggregator

      - name: Build
        run: nix-shell --run '.github/workflows/ci-build.sh'

      - name: Test
        run: nix-shell --run '.github/workflows/ci-test.sh'

  terraform:
    runs-on: ubuntu-latest
    needs: [ docker-mithril-aggregator, docker-mithril-client ]
    env:
      # Contains a JSON-formatted service account key
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      # Contains a RSA private key
      GCLOUD_PRIVATE_KEY: ${{ secrets.GCLOUD_PRIVATE_KEY }}
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

    defaults:
      run:
        working-directory: mithril-network/mithril-infra

    steps:

    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Get short SHA
      id: slug
      run: echo "::set-output name=sha8::$(echo ${{ github.sha }} | cut -c1-7)"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false

    - name: Init Terraform
      run: terraform init

    - name: Check Terraform
      run: terraform fmt -check

    - name: Terraform Plan
      run: |
        terraform plan -var "image_id=${{ env.BRANCH_NAME }}-${{ steps.slug.outputs.sha8 }}" -var 'private_key=${{ env.GCLOUD_PRIVATE_KEY }}' -var 'google_application_credentials_json=${{ env.GOOGLE_CREDENTIALS }}'

    - name: Update Pull Request
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      env:
        PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `#### Terraform Format and Style 🖌\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization ⚙️\`${{ steps.init.outcome }}\`
          #### Terraform Plan 📖\`${{ steps.plan.outcome }}\`
          #### Terraform Validation 🤖\`${{ steps.validate.outcome }}\`

          <details><summary>Show Plan</summary>

          \`\`\`\n
          ${process.env.PLAN}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        terraform apply -auto-approve  -var "image_id=${{ env.BRANCH_NAME }}-${{ steps.slug.outputs.sha8 }}" -var 'private_key=${{ env.GCLOUD_PRIVATE_KEY }}' -var 'google_application_credentials_json=${{ env.GOOGLE_CREDENTIALS }}'
