"use strict";(self.webpackChunkmithril_doc=self.webpackChunkmithril_doc||[]).push([[7824],{7918:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>o});var s=n(87011),i=n(74848),r=n(28453);const a={slug:8,title:"8. Standardize JSON Message Testing\n",authors:[{name:"Mithril Team"}],tags:["Accepted"],date:new Date("2025-01-14T00:00:00.000Z")},d=void 0,c={authorsImageUrls:[void 0]},o=[{value:"Status",id:"status",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Consequences",id:"consequences",level:2}];function l(e){const t={code:"code",h2:"h2",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"status",children:"Status"}),"\n",(0,i.jsx)(t.p,{children:"Accepted"}),"\n",(0,i.jsx)(t.h2,{id:"context",children:"Context"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"To ensure backward compatibility and correctness of JSON messages exchanged between nodes, we need a standardized approach\nto test the deserialization of these messages."}),"\n",(0,i.jsx)(t.li,{children:"Golden testing is a technique where the expected output (golden data) is stored and used to verify the correctness of\nthe system's output. This approach helps in detecting unintended changes in the output and ensures that the system\nbehaves as expected over time."}),"\n",(0,i.jsx)(t.li,{children:"By using golden testing for JSON message deserialization, we can ensure that any changes to the message structures are\nbackward compatible and that the deserialization process yields the expected results."}),"\n",(0,i.jsx)(t.li,{children:"We have been using golden testing for JSON messages in the project, but the approach used ad-hoc versions that did not\ncorrespond to any OpenAPI versions, making it difficult to track the changes and maintain backward compatibility."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"decision",children:"Decision"}),"\n",(0,i.jsx)(t.p,{children:"We will standardize the testing of JSON messages by following the steps below:"}),"\n",(0,i.jsx)(t.p,{children:"When adding a new JSON message structure, the following steps should be taken:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Introduce a constant ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," string containing an exhaustive example of the JSON currently exchanged between nodes."]}),"\n",(0,i.jsxs)(t.li,{children:["Implement a ",(0,i.jsx)(t.code,{children:"golden_message_current"})," method that returns the representation of the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," using the current structure."]}),"\n",(0,i.jsxs)(t.li,{children:["Implement a ",(0,i.jsx)(t.code,{children:"test_current_json_deserialized_into_current_message"})," test that checks that deserializing the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," into the current structure yields the output stored in ",(0,i.jsx)(t.code,{children:"golden_message_current"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"When modifying an existing JSON message structure, if backward compatibility is maintained, the following steps should be taken:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Given ",(0,i.jsx)(t.code,{children:"X_Y_ZZ"})," is the version of the OpenAPI before the change:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Create a copy of the previous version structure as it was before the backward-compatible change, suffixed with ",(0,i.jsx)(t.code,{children:"UntilVX_Y_ZZ"}),", e.g., ",(0,i.jsx)(t.code,{children:"CertificateMessageUntilV0_1_32"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["Create a copy the ",(0,i.jsx)(t.code,{children:"golden_message_current"})," method named ",(0,i.jsx)(t.code,{children:"golden_message_until_open_api_X_Y_ZZ"}),", and update its return type to the version structure suffixed with ",(0,i.jsx)(t.code,{children:"UntilVX_Y_ZZ"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["Implement a ",(0,i.jsx)(t.code,{children:"test_current_json_deserialized_into_message_supported_until_open_api_X_Y_ZZ"})," test that checks that deserializing the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," into the previous structure yields the output stored in ",(0,i.jsx)(t.code,{children:"golden_message_until_open_api_X_Y_ZZ"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["Modify the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," string to reflect the new structure."]}),"\n",(0,i.jsxs)(t.li,{children:["Modify the ",(0,i.jsx)(t.code,{children:"golden_message_current"})," method to return the representation of the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," using the new structure."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"When modifying an existing JSON message structure, if backward compatibility is not maintained, the following steps should be taken:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Modify the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," string to reflect the new structure."]}),"\n",(0,i.jsxs)(t.li,{children:["Modify the ",(0,i.jsx)(t.code,{children:"golden_message_current"})," method to return the representation of the ",(0,i.jsx)(t.code,{children:"CURRENT_JSON"})," using the new structure."]}),"\n",(0,i.jsxs)(t.li,{children:["Remove all ",(0,i.jsx)(t.code,{children:"golden_message_until_open_api_X_Y_ZZ"})," method and the corresponding structure and tests, as they are no longer relevant."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"consequences",children:"Consequences"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Ensures that any changes to the JSON message structure are backward compatible."}),"\n",(0,i.jsx)(t.li,{children:"Provides a clear and standardized approach to testing JSON message deserialization."}),"\n",(0,i.jsx)(t.li,{children:"Helps maintain the integrity and reliability of the communication between nodes."}),"\n",(0,i.jsx)(t.li,{children:"Requires maintaining multiple versions of message structures and corresponding tests, which may increase the maintenance overhead."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>d});var s=n(96540);const i={},r=s.createContext(i);function a(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:t},e.children)}},87011:e=>{e.exports=JSON.parse('{"permalink":"/doc/adr/8","source":"@site/adr/008-standardize-json-messages-testing.md","title":"8. Standardize JSON Message Testing\\n","description":"Status","date":"2025-01-14T00:00:00.000Z","tags":[{"inline":true,"label":"Accepted","permalink":"/doc/adr/tags/accepted"}],"readingTime":2.2,"hasTruncateMarker":false,"authors":[{"name":"Mithril Team","socials":{},"key":null,"page":null}],"frontMatter":{"slug":"8","title":"8. Standardize JSON Message Testing\\n","authors":[{"name":"Mithril Team"}],"tags":["Accepted"],"date":"2025-01-14T00:00:00.000Z"},"unlisted":false,"prevItem":{"title":"9. Database migration squashing\\n","permalink":"/doc/adr/9"},"nextItem":{"title":"7. Standardize log output\\n","permalink":"/doc/adr/7"}}')}}]);